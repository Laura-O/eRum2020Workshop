---
title: "Bring your R Application Safely to Production."
subtitle: "Collaborate, Deploy, Automate."
author: "Francesca Vitalini"
date: "`r Sys.Date()`"
output:
  xaringan::moon_reader:
    lib_dir: libs
    css: ["default", "styles.css"]
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
      slideNumberFormat: "%current%/%total%"
---

```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE)
```

layout: true

<div class="my-footer"><span>Copyright (c) 2020</span></div> 

---

![devCycle](./img/MiraiApr19_full.jpg)

<br>

### Bring ideas to life.
### Smart. Agile. Personal.

```{r eval = TRUE, echo = FALSE, out.width = "50%", out.extra='style="position:absolute;bottom:100px;right:50px;"'}
knitr::include_graphics("./img/mirai-solutions-logo-flyer.png")
```

---

## Workshop Overview

- Fork the starting point package and shiny app
- Version control
- Automating controls on TravisCI
- **Break**
- Gitflow
- Agile development
- Pull requests and branches control
- Deploymnet on shinyapps.io
- **Break**
- GitHub Actions
- Automatic Deployment
- Release
- Conclusions

---

class: inverse center middle
## At the beginning there was a shiny app

---

## Shiny app

Describe Starting point Productive object → shiny app 
Is an existing simple production ready package available on github they can fork.

---

## How to Fork

Instructions to make a fork on GitHub

---

## Project structure

Show package includes functions and unit test, documentation, and a shiny app.
Motivation: packaged shiny app to use RMD check; explain “production ready” → summary of Vanlog’s workshop main points

---

### Package

*"In R, the fundamental unit of shareable code is the package. A package bundles together code, data, documentation, and tests, and is easy to share with others."*, [Introduction to R packages by Hadley Wickham](http://r-pkgs.had.co.nz/intro.html)

```{r eval = TRUE, echo = FALSE, out.width = "80%", out.extra='style="position:absolute;bottom:100px;right:50px;"'}
knitr::include_graphics("./img/package_structure.png")
```

---

## Production Ready

Running RMD Check discover documentation is incomplete (they need to fix it).

---

# What does Production mean?

The product-building process is an automated, streamlined pipeline, optimized for speed of delivery to the end-user.

By automating building and testing processes, the pipeline to production ensures:

  - Security  
  - Quality  
  - Stability  
  
Production is not a fixed object, but a continuous improvement cycle.

```{r eval = TRUE, echo = FALSE, out.width = "35%", out.extra='style="position:absolute;bottom:60px;right:50px;"'}
knitr::include_graphics("./img/devCycle.001.png")
```

---

## Best Practices

Modularize your code. (functions and package structure in R)

Have your building blocks general and flexible.

Make your code robust with automated testing.

Trace your work with a version control system

---

## Version Control

Version control → code versioned and not just local. Starting point for collaborative work

```{r eval = TRUE, echo = FALSE, out.width = "80%", out.extra='style="position:absolute;top:200px;left:50px;"'}
knitr::include_graphics("./img/git.png")
```

`R CMD check`

```{r eval = TRUE, echo = FALSE, out.width = "60%", out.extra='style="position:absolute;bottom:50px;right:50px;"'}
knitr::include_graphics("./img/R-CMD-checks.png")
```

---

## Automating Controls

Benefits of automating controls → travis → make an example that looks innocuous but fails. One does not want to rely on people manually running checks before committing.

Continuous Integration (CI) is the practice of automatically merging current development work to a shared mainline, also multiple time a day. 

---

## Travis CI

Travis CI is an open-source continuous integration service that can be used to build and test software projects hosted on GitHub.

`usethis::use_travis(ext = "com")` creates a Travis CI configuration file (`.travis.yml`)

```{yaml, eval = FALSE}
language: r
cache: packages
```

To enable Travis CI go to [Travis-ci.com](https://travis-ci.com/) and Sign up with GitHub.

On Travis CI the user needs to select the repositories on which to activate the continuous integration.

Then GitHub notifies Travis CI of the occurrence of new commits / pull requests, triggering actions on Travis CI as specified in .travis.yml

A badge indicating the CI status can be integrated in the `README.md`.

---

class: inverse center middle
# Break

---

## Gitflow

Collaboration, gitflow. → branches (develop / feature), control development process, work in parallel. 

.pull-left[
[Gitflow](https://nvie.com/posts/a-successful-git-branching-model/) is a standard setup that allows a collaborative development, while assuring the safety of the released product.

According to the Gitflow approach, the central repo holds two main branches with an infinite lifetime:
master: branch where source code of HEAD always reflects a production-ready state.
develop: branch where source code of HEAD always reflects a state with the latest delivered developments for the next release. 
Each feature branch provides an additional incremental value to the product, potentially ready for deployment. ]

.pull-right[
```{r eval = TRUE, echo = FALSE, out.width = "40%", out.extra='style="position:absolute;bottom:50px;right:50px;"'}
knitr::include_graphics("./img/gitflow.png")
```
https://nvie.com/posts/a-successful-git-branching-model/
]

---

## Collaboration

Gitflow is an Agile framework by nature.

```{r eval = TRUE, echo = FALSE, out.width = "80%", out.extra='style="position:absolute;bottom:100px;right:50px;"'}
knitr::include_graphics("./img/project-board.png")
```

---

## New Issues

screenshot on how to make one.
show how to create a branch.
Live: fix issue on the branch --> make a pull request to merge this into the main branch

---

## Pull Requests and branches control

Pull requests control branches. Necessity of controls on pull requests to ensure robustness and stability of the code.

Set restrictions on branches: require review and status check (travis-ci) before merging to master or develop. 
Screenshot on where to set branches controls?

Screenshots to see the checks passibg before merging?

---

## Deployment shinyapps.io

Setup shinyapp.io → is our productive environment
Manual deployment → check all works

---

## Agile Development

#### Why DevOps?

**Goals**
Achieve faster time to production
Enable more frequent deployments
Lower failure rate of new releases
Shorten lead time between fixes
Enhance collaboration between groups


**Challenges**
Mindset and Culture
Security
Responsibility


**Benefits**
Development via small work items increases the speed of development and improves its quality.
Slow, repetitive and human made actions are error-prone. Automation in testing and deployment increases the stability of the production process.
Version controlled development ensures traceability and repeatability of the development.
Collaboration and an agile approach are keys to a functional production pipeline.
Building, testing and deploying discrete development components improve confidence in the final product.


Note:
Infrastructure can also follow a continuous delivery philosophy (Infrastructure as Code).

**DevOps is a culture. Tools can enable it.**


```{r eval = TRUE, echo = FALSE, out.width = "80%", out.extra='style="position:absolute;bottom:100px;right:50px;"'}
knitr::include_graphics("./img/devops.001.png")
```

---

class: inverse center middle
# Break

---

## GitHub Actions

How to set up CI in GitHub Actions

---

## Automatic Deployment

Automatic deployment / continuous deployment via github actions → streamline deployment process (DevOps). Exercise: Automatic deployment / continuous deployment via travis → streamline deployment process (DevOps) → link tech guides

SCRENSHOT OF THE CHECKS PASSING?

---

## Tockens

---

## Secrets

---

## Release

Release concept → you plan a release with a specific chunk of development. Release branch. Tags. Versions.

According to the Gitflow approach, no work should be pushed directly to `master`, which is updated as part of a release with a pull request from a stable `develop` branch or a `release` branch.

Create a release branch (e.g. `release/v2.0.0`) from `develop`.

Consolidate the changelog (`NEWS.md` in R, see e.g. [recommendations](http://r-pkgs.had.co.nz/release.html#important-files) and [style guide](https://style.tidyverse.org/news.html#news-release)).
Example
```
1.0.0 release preps
* Closes #XYZ Updated report.
```

Update package version (NEWS.md and DESCRIPTION files in R).

Create and merge a new pull request release/v2.0.0 →  master,  where the `closes XXX` are in the pull request comment.

Create a new release tag on master (on [GitHub Code > releases > Draft new release](https://github.com/miraisolutions/SmaRP/releases/new)).
  - Tag version: v1.0.1
  - Release title: packagename 1.0.1
  - Body: Paste as comment the list of changes in `NEWS.md`
  - Click on "Publish release"

Create a new pull request and merge release/v2.0.0  →  develop

Prepare for next version on develop (by changing the version NEWS.md and DESCRIPTION files).

SCREENSHOT OF RELEASE TAG?

---

## Conclusions

Final product and release

---

class: inverse center middle
# What's Next

---

## Next Steps

Next Steps, technical info → close workshop

---

class: inverse center middle
# Thank you!
